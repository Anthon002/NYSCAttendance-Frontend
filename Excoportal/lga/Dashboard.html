<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYSC Admin Dashboard</title>
    <!-- Tailwind CSS for Layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f8fafc;
            /* Light Slate Blue/Gray */
            color: #1e293b;
        }

        .nysc-green-bg {
            background-color: #006d3a;
        }

        .nysc-green-text {
            color: #006d3a;
        }

        .nysc-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s;
        }

        .lga-grid-item {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
            height: 140px;
            /* Fixed height for uniformity */
            overflow: hidden;
            border: 1px solid #e2e8f0;
            cursor: pointer; /* Added cursor pointer to indicate clickability */
        }

        .lga-grid-item:hover {
             border-color: #006d3a;
             box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #006d3a;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #005a30;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #f1f5f9;
            color: #334155;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        #map-container, #edit-map-container {
            height: 400px;
            width: 100%;
            border-radius: 8px;
        }

        /* Style for the searchable LGA list items */
        .lga-list-container .hover\:bg-green-50:hover {
            background-color: #f0fff4;
        }

        /* Time picker styles */
        .time-picker-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .time-picker-group {
            flex: 1;
        }

        .time-picker-input {
            width: 100%;
            height: 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 1.25rem;
            text-align: center;
            font-weight: 600;
            color: #006d3a;
            cursor: pointer;
        }

        .time-picker-input:focus {
            outline: none;
            ring: 2px;
            ring-color: #006d3a;
            border-color: #006d3a;
        }

        .time-picker-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .time-picker-btn {
            width: 32px;
            height: 24px;
            padding: 0;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background-color: #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .time-picker-btn:hover {
            background-color: #e5e7eb;
        }

        .time-picker-btn:active {
            background-color: #d1d5db;
        }

        .time-separator {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            align-self: center;
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Header/Navigation -->
    <header class="nysc-green-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">NYSC Admin Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="admin-email" class="text-sm font-medium opacity-80 hidden sm:inline"></span>
                <button id="logout-btn"
                    class="bg-white text-gray-800 px-3 py-1 rounded-full text-sm font-semibold hover:bg-gray-200 transition">
                    <i class="fa-solid fa-right-from-bracket mr-1"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">LGA Attendance Points</h2>

        <!-- Search and Actions Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
            <!-- Search Input -->
            <div class="relative w-full sm:w-80">
                <input type="text" id="search-input" placeholder="Search LGA name or token..."
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-sm">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <!-- Action Button (Placeholder) -->
            <button id="add-lga-btn"
                class="btn-primary px-4 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transition">
                <i class="fa-solid fa-plus mr-2"></i> Add New LGA Point
            </button>
        </div>

        <!-- LGA Locations Grid Container -->
        <div id="lga-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- LGA cards will be injected here -->
            <div id="loading-spinner" class="col-span-full text-center py-16">
                <i class="fa-solid fa-spinner fa-spin text-4xl nysc-green-text"></i>
                <p class="mt-4 text-gray-500">Loading LGA points...</p>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" class="mt-8 flex justify-between items-center nysc-card p-4 hidden">
            <button id="prev-page-btn" class="btn-primary px-4 py-2 rounded-lg" disabled>
                <i class="fa-solid fa-arrow-left mr-2"></i> Previous
            </button>
            <span class="text-sm font-medium text-gray-700">
                Page <span id="current-page-display">1</span> of <span id="total-pages-display">1</span>
                (<span id="total-records-display">0</span> records)
            </span>
            <button id="next-page-btn" class="btn-primary px-4 py-2 rounded-lg" disabled>
                Next <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>

    </main>

    <!-- Toast Notification Container (Top Right) -->
    <div id="toast-container" class="max-w-xs w-full fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <!-- Toast content is injected here -->
    </div>

    <!-- Add LGA Modal (Hidden by Default) - ID remains 'lga-modal' for the 'Add' action -->
    <div id="lga-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden flex items-center justify-center transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 transition-transform transform scale-95"
            role="dialog" aria-modal="true" aria-labelledby="modal-title">

            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New LGA Attendance Point</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <!-- The content of this modal is cloned to the edit modal -->
            <form id="lga-form" onsubmit="event.preventDefault(); submitLGAForm()">
                <input type="hidden" id="lga-id-input" name="id"> <!-- Hidden field for ID in case of Edit -->

                <!-- Step 1: Location Selection (Map) -->
                <div id="step-1" class="form-step">
                    <p class="mb-4 text-gray-600">Step 1: Select the attendance location on the map or use your current location.</p>
                    <div id="map-container" class="mb-4"></div>
                    <p id="coords-display" class="text-sm font-medium text-gray-700">Coordinaes: Not Selected</p>
                    <input type="hidden" id="latitude-input" name="latitude">
                    <input type="hidden" id="longitude-input" name="longitude">
                    <div class="mt-6 flex justify-between">
                        <button type="button" id="use-current-location-btn"
                            class="btn-secondary px-4 py-2 rounded-lg font-semibold transition flex items-center">
                            <i class="fa-solid fa-location-crosshairs mr-2"></i> Use Current Location
                        </button>
                        <button type="button" id="next-step-1" class="btn-primary px-6 py-2 rounded-lg" disabled>
                            Next <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: LGA Name Selection (Searchable Dropdown) -->
                <div id="step-2" class="form-step hidden">
                    <p class="mb-4 text-gray-600">Step 2: Select the LGA name and optionally a serial number for the point.</p>
                    
                    <div class="relative">
                        <label for="lga-search-input" class="block text-sm font-medium text-gray-700 mb-2">LGA Name</label>
                        <!-- Display input for search/selection -->
                        <input type="text" id="lga-search-input" readonly
                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500 transition bg-white cursor-pointer"
                            placeholder="Click to search and select LGA">
                        <!-- Hidden input to hold the final value for form submission -->
                        <input type="hidden" id="lga-hidden-input" name="name">

                        <!-- Searchable Dropdown Container -->
                        <div id="lga-dropdown-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-xl hidden">
                            <input type="text" id="lga-filter-input"
                                class="w-full p-2 border-b border-gray-200 rounded-t-lg focus:outline-none focus:ring-green-500 focus:border-green-500"
                                placeholder="Type to search all 775 LGAs...">
                            <!-- Scrollable List Area -->
                            <div id="lga-list-container" class="max-h-64 overflow-y-auto lga-list-container">
                                <div class="p-3 text-gray-500 text-sm">Start by clicking the input or typing in the search box above.</div>
                            </div>
                        </div>
                    </div>

                    <p id="lga-error-msg" class="mt-2 text-sm text-red-500 hidden">Please select an LGA name.</p>

                    <!-- Optional Serial Number Dropdown -->
                    <div class="mt-4">
                        <label for="lga-serial-select" class="block text-sm font-medium text-gray-700 mb-2">Optional Serial Number (1-5)</label>
                        <select id="lga-serial-select" name="serialNumber"
                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500 transition">
                            <option value="">-- None (Primary Point) --</option>
                            <option value=" 1">1</option>
                            <option value=" 2">2</option>
                            <option value=" 3">3</option>
                            <option value=" 4">4</option>
                            <option value=" 5">5</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">The serial number will be appended to the LGA name (e.g., "Ikeja Main 1").</p>
                    </div>
                    
                    <!-- Skip/Original Value indicator (Hidden for ADD, Visible for EDIT) -->
                    <p id="lga-skip-info" class="mt-3 text-sm text-yellow-600 hidden">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Current value: <span id="lga-original-value" class="font-semibold"></span>. Leave blank to skip update.
                    </p>

                    <div class="mt-6 flex justify-between">
                        <button type="button" id="back-step-2"
                            class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Back
                        </button>
                        <button type="button" id="next-step-2" class="btn-primary px-6 py-2 rounded-lg" disabled>
                            Next <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Distance Setting -->
                <div id="step-3" class="form-step hidden">
                    <p class="mb-4 text-gray-600">Step 3: Set the maximum distance (in meters) for attendance check.</p>
                    <label for="distance-input" class="block text-sm font-medium text-gray-700 mb-2">Distance in Meters</label>
                    <input type="number" id="distance-input" name="distanceInMeters" min="5" max="5000" value="50" required
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500 transition">
                    <p class="mt-1 text-xs text-gray-500">This is the maximum radius (in meters) a corp member can be from this point to record attendance.</p>
                    
                    <!-- Skip/Original Value indicator (Hidden for ADD, Visible for EDIT) -->
                    <p id="distance-skip-info" class="mt-3 text-sm text-yellow-600 hidden">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Current value: <span id="distance-original-value" class="font-semibold"></span>m. Leave to keep.
                    </p>

                    <div class="mt-6 flex justify-between">
                        <button type="button" id="back-step-3"
                            class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Back
                        </button>
                        <button type="button" id="next-step-3" class="btn-primary px-6 py-2 rounded-lg">
                            Next <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Opening and Closing Times (NEW FINAL STEP) -->
                <div id="step-4" class="form-step hidden">
                    <p class="mb-6 text-gray-600">Step 4: Set the opening and closing times for this attendance point.</p>
                    
                    <!-- Opens At Time Picker -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Opens At</label>
                        <div class="time-picker-container">
                            <!-- Hour -->
                            <div class="time-picker-group">
                                <div class="time-picker-buttons mb-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="incrementOpensHour()">
                                        <i class="fa-solid fa-chevron-up text-xs"></i>
                                    </button>
                                </div>
                                <input type="text" id="opens-hour-input" class="time-picker-input" value="09" readonly>
                                <div class="time-picker-buttons mt-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="decrementOpensHour()">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="time-separator">:</div>

                            <!-- Minute -->
                            <div class="time-picker-group">
                                <div class="time-picker-buttons mb-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="incrementOpensMinute()">
                                        <i class="fa-solid fa-chevron-up text-xs"></i>
                                    </button>
                                </div>
                                <input type="text" id="opens-minute-input" class="time-picker-input" value="00" readonly>
                                <div class="time-picker-buttons mt-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="decrementOpensMinute()">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Closes At Time Picker -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Closes At</label>
                        <div class="time-picker-container">
                            <!-- Hour -->
                            <div class="time-picker-group">
                                <div class="time-picker-buttons mb-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="incrementClosesHour()">
                                        <i class="fa-solid fa-chevron-up text-xs"></i>
                                    </button>
                                </div>
                                <input type="text" id="closes-hour-input" class="time-picker-input" value="09" readonly>
                                <div class="time-picker-buttons mt-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="decrementClosesHour()">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="time-separator">:</div>

                            <!-- Minute -->
                            <div class="time-picker-group">
                                <div class="time-picker-buttons mb-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="incrementClosesMinute()">
                                        <i class="fa-solid fa-chevron-up text-xs"></i>
                                    </button>
                                </div>
                                <input type="text" id="closes-minute-input" class="time-picker-input" value="00" readonly>
                                <div class="time-picker-buttons mt-2 flex justify-center">
                                    <button type="button" class="time-picker-btn" onclick="decrementClosesMinute()">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden inputs to store final time values -->
                    <input type="hidden" id="opens-at-input" name="opensAt">
                    <input type="hidden" id="closes-at-input" name="closesAt">

                    <div class="mt-6 flex justify-between">
                        <button type="button" id="back-step-4"
                            class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Back
                        </button>
                        <button type="submit" id="submit-lga-form-btn" class="btn-primary px-6 py-2 rounded-lg">
                            <i class="fa-solid fa-check mr-2"></i> Create Point
                        </button>
                    </div>
                </div>

            </form>

        </div>
    </div>
    
    <!-- JavaScript Logic -->
    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // --- Configuration ---
        const BASE_URL = "https://nyscattendance.somee.com"; 
        const LGA_ENDPOINT = `${BASE_URL}/api/Admin/LGA`;
        const TOAST_DURATION = 3000;
        
        // Frontend URL for corps member portal (relative to the base)
        const CORP_MEMBER_PORTAL_PATH = "/Excoportal/lga/index.html"; 

        // New URL for LGA details page
        const LGA_DETAILS_PAGE = "LgaDetails.html"; 

        // --- State Variables ---
        let currentPage = 1;
        const pageSize = 9; // Display 9 items per page

        // Modal State (only ADD mode now)
        let currentStep = 1; // current step within Add modal
        let map;
        let marker;
        let selectedCoords = { lat: null, lng: null }; // For ADD mode

        // Global LGAs list (Mocking the 775 LGAs)
        const allNigerianLGAs = [
    // Abia (17)
    "Aba North","Aba South","Arochukwu","Bende","Ikwuano","Isiala Ngwa North","Isiala Ngwa South","Isuikwuato","Obi Ngwa","Ohafia","Osisioma Ngwa","Ugwunagbo","Ukwa East","Ukwa West","Umuahia North","Umuahia South","Umu Nneochi",

    // Adamawa (21)
    "Demsa","Fufore","Ganye","Girei","Gombi","Guyuk","Hong","Jada","Lamurde","Madagali","Maiha","Mayo Belwa","Michika","Mubi North","Mubi South","Numan","Shelleng","Song","Toungo","Yola North","Yola South",

    // Akwa Ibom (31)
    "Abak","Eastern Obolo","Eket","Esit Eket","Essien Udim","Etim Ekpo","Etinan","Ibeno","Ibesikpo Asutan","Ibiono Ibom","Ika","Ikono","Ikot Abasi","Ikot Ekpene","Ini","Itu","Mbo","Mkpat Enin","Nsit Atai","Nsit Ibom","Nsit Ubium","Obot Akara","Okobo","Onna","Oron","Oruk Anam","Udung Uko","Ukanafun","Uruan","Urue Offong/Oruko","Uyo",

    // Anambra (21)
    "Aguata","Anambra East","Anambra West","Anaocha","Awka North","Awka South","Ayamelum","Dunukofia","Ekwusigo","Idemili North","Idemili South","Ihiala","Njikoka","Nnewi North","Nnewi South","Ogbaru","Onitsha North","Onitsha South","Orumba North","Orumba South","Oyi",

    // Bauchi (20)
    "Alkaleri","Bauchi","Bogoro","Damban","Darazo","Dass","Gamawa","Ganjuwa","Giade","Itas Gadau","Jama'are","Katagum","Kirfi","Misau","Ningi","Shira","Tafawa Balewa","Toro","Warji","Zaki",

    // Bayelsa (8)
    "Brass","Ekeremor","Kolokuma/Opokuma","Nembe","Ogbia","Sagbama","Southern Ijaw","Yenagoa",

    // Benue (23)
    "Ado","Agatu","Apa","Buruku","Gboko","Guma","Gwer East","Gwer West","Katsina-Ala","Konshisha","Kwande","Logo","Makurdi","Obi","Ogbadibo","Ohimini","Oju","Okpokwu","Oturkpo","Tarka","Ukum","Ushongo","Vandeikya",

    // Borno (27)
    "Abadam","Askira/Uba","Bama","Bayo","Biu","Chibok","Damboa","Dikwa","Gubio","Guzamala","Gwoza","Hawul","Jere","Kaga","Kala/Balge","Konduga","Kukawa","Kwaya Kusar","Mafa","Magumeri","Maiduguri","Marte","Mobbar","Monguno","Ngala","Nganzai","Shani",

    // Cross River (18)
    "Abi","Akamkpa","Akpabuyo","Bakassi","Bekwarra","Biase","Boki","Calabar Municipal","Calabar South","Etung","Ikom","Obanliku","Obubra","Obudu","Odukpani","Ogoja","Yakuur","Yala",

    // Delta (25)
    "Aniocha North","Aniocha South","Bomadi","Burutu","Ethiope East","Ethiope West","Ika North East","Ika South","Isoko North","Isoko South","Ndokwa East","Ndokwa West","Okpe","Oshimili North","Oshimili South","Patani","Sapele","Udu","Ughelli North","Ughelli South","Ukwuani","Uvwie","Warri North","Warri South","Warri South West",

    // Ebonyi (13)
    "Abakaliki","Afikpo North","Afikpo South","Ebonyi","Ezza North","Ezza South","Ikwo","Ishielu","Ivo","Izzi","Ohaozara","Ohaukwu","Onicha",

    // Edo (18)
    "Akoko-Edo","Egor","Esan Central","Esan North-East","Esan South-East","Esan West","Etsako Central","Etsako East","Etsako West","Igueben","Ikpoba-Okha","Orhionmwon","Ovia North-East","Ovia South-West","Owan East","Owan West","Uhunmwonde",

    // Ekiti (16)
    "Ado Ekiti","Efon","Ekiti East","Ekiti South-West","Ekiti West","Emure","Gbonyin","Ido Osi","Ijero","Ikere","Ikole","Ilejemeje","Irepodun/Ifelodun","Ise/Orun","Moba","Oye",

    // Enugu (17)
    "Aninri","Awgu","Enugu East","Enugu North","Enugu South","Ezeagu","Igbo Etiti","Igbo Eze North","Igbo Eze South","Isi Uzo","Nkanu East","Nkanu West","Nsukka","Oji River","Udenu","Udi","Uzo-Uwani",

    // Gombe (11)
    "Akko","Balanga","Billiri","Dukku","Funakaye","Gombe","Kaltungo","Kwami","Nafada","Shongom","Yamaltu/Deba",

    // Imo (27)
    "Aboh Mbaise","Ahiazu Mbaise","Ehime Mbano","Ezinihitte","Ideato North","Ideato South","Ihitte/Uboma","Ikeduru","Isiala Mbano","Isu","Mbaitoli","Ngor Okpala","Njaba","Nkwerre","Nwangele","Obowo","Oguta","Ohaji/Egbema","Okigwe","Onuimo","Orlu","Orsu","Oru East","Oru West","Owerri Municipal","Owerri North","Owerri West",

    // Jigawa (27)
    "Auyo","Babura","Biriniwa","Birnin Kudu","Buji","Dutse","Gagarawa","Garki","Gumel","Guri","Gwaram","Gwiwa","Hadejia","Jahun","Kafin Hausa","Kazaure","Kiri Kasama","Kiyawa","Kaugama","Maigatari","Malam Madori","Miga","Ringim","Roni","Sule Tankarkar","Taura","Yankwashi",

    // Kaduna (23)
    "Birnin Gwari","Chikun","Giwa","Igabi","Ikara","Jaba","Jema'a","Kachia","Kaduna North","Kaduna South","Kagarko","Kajuru","Kaura","Kauru","Kubau","Kudan","Lere","Makarfi","Sabon Gari","Sanga","Soba","Zangon Kataf","Zaria",

    // Kano (44)
    "Ajingi","Albasu","Bagwai","Bebeji","Bichi","Bunkure","Dala","Dambatta","Dawakin Kudu","Dawakin Tofa","Doguwa","Fagge","Gabasawa","Garko","Garun Mallam","Gaya","Gezawa","Gwale","Gwarzo","Kabo","Kano Municipal","Kibiya","Kiru","Kumbotso","Kunchi","Kura","Madobi","Makoda","Minjibir","Nasarawa","Rano","Rimin Gado","Rogo","Shanono","Sumaila","Takai","Tarauni","Tofa","Tsanyawa","Tudun Wada","Ungogo","Warawa","Wudil",

    // Katsina (34)
    "Bakori","Batagarawa","Batsari","Baure","Bindawa","Charanchi","Dandume","Danja","Dan Musa","Daura","Dutsi","Dutsin Ma","Faskari","Funtua","Ingawa","Jibia","Kafur","Kaita","Kankara","Kankia","Katsina","Kurfi","Kusada","Mai'Adua","Malumfashi","Mani","Mashi","Matazu","Musawa","Rimi","Sabuwa","Safana","Sandamu","Zango",

    // Kebbi (21)
    "Aleiro","Arewa Dandi","Argungu","Augie","Bagudo","Birnin Kebbi","Bunza","Dandi","Fakai","Gwandu","Jega","Kalgo","Koko/Besse","Maiyama","Ngaski","Sakaba","Shanga","Suru","Wasagu/Danko","Yauri","Zuru",

    // Kogi (21)
    "Adavi","Ajaokuta","Ankpa","Bassa","Dekina","Ibaji","Idah","Igalamela Odolu","Ijumu","Kabba/Bunu","Kogi","Lokoja","Mopa Muro","Ofu","Ogori/Magongo","Okehi","Okene","Olamaboro","Omala","Yagba East","Yagba West",

    // Kwara (16)
    "Asa","Baruten","Edu","Ekiti","Ifelodun","Ilorin East","Ilorin South","Ilorin West","Irepodun","Isin","Kaiama","Moro","Offa","Oke Ero","Oyun","Pategi",

    // Lagos (20)
    "Agege","Ajeromi-Ifelodun","Alimosho","Amuwo-Odofin","Apapa","Badagry","Eti-Osa","Ibeju-Lekki","Ifako-Ijaiye","Ikeja","Ikorodu","Kosofe","Lagos Island","Lagos Mainland","Mushin","Ojo","Oshodi-Isolo","Shomolu","Surulere","Epe",

    // Nasarawa (13)
    "Akwanga","Awe","Doma","Karu","Keana","Keffi","Kokona","Lafia","Nasarawa","Nasarawa Eggon","Obi","Toto","Wamba",

    // Niger (25)
    "Agaie","Agwara","Bida","Borgu","Bosso","Chanchaga","Edati","Gbako","Gurara","Katcha","Kontagora","Lapai","Lavun","Magama","Mariga","Mashegu","Mokwa","Muya","Paikoro","Rafi","Rijau","Shiroro","Suleja","Tafa","Wushishi",

    // Ogun (20)
    "Abeokuta North","Abeokuta South","Ado-Odo/Ota","Egbado North","Egbado South","Ewekoro","Ifo","Ijebu East","Ijebu North","Ijebu North East","Ijebu Ode","Ikenne","Imeko Afon","Ipokia","Obafemi Owode","Odeda","Odogbolu","Ogun Waterside","Remo North","Shagamu",

    // Ondo (18)
    "Akoko North-East","Akoko North-West","Akoko South-West","Akoko South-East","Akure North","Akure South","Ese Odo","Idanre","Ifedore","Ilaje","Ile Oluji/Okeigbo","Irele","Odigbo","Okitipupa","Ondo East","Ondo West","Ose","Owo",

    // Osun (30)
    "Atakunmosa East","Atakunmosa West","Aiyedaade","Aiyedire","Boluwaduro","Boripe","Ede North","Ede South","Egbedore","Ejigbo","Ife Central","Ife East","Ife North","Ife South","Ifedayo","Ifelodun","Ila","Ilesa East","Ilesa West","Irepodun","Irewole","Isokan","Iwo","Obokun","Odo Otin","Ola Oluwa","Olorunda","Oriade","Orolu","Osogbo",

    // Oyo (33)
    "Afijio","Akinyele","Atiba","Atisbo","Egbeda","Ibadan North","Ibadan North-East","Ibadan North-West","Ibadan South-East","Ibadan South-West","Ibarapa Central","Ibarapa East","Ibarapa North","Ido","Irepo","Iseyin","Itesiwaju","Iwajowa","Kajola","Lagelu","Ogbomosho North","Ogbomosho South","Ogo Oluwa","Olorunsogo","Oluyole","Ona Ara","Orelope","Ori Ire","Oyo East","Oyo West","Saki East","Saki West","Surulere",

    // Plateau (17)
    "Barkin Ladi","Bassa","Bokkos","Jos East","Jos North","Jos South","Kanam","Kanke","Langtang North","Langtang South","Mangu","Mikang","Pankshin","Qua'an Pan","Riyom","Shendam","Wase",

    // Rivers (23)
    "Abua–Odual","Ahoada East","Ahoada West","Akuku-Toru","Andoni","Asari-Toru","Bonny","Degema","Eleme","Emuoha","Etche","Gokana","Ikwerre","Khana","Obio-Akpor","Ogba–Egbema–Ndoni","Ogu–Bolo","Okrika","Omuma","Opobo–Nkoro","Oyigbo","Port Harcourt","Tai",

    // Sokoto (23)
    "Binji","Bodinga","Dange Shuni","Gada","Goronyo","Gudu","Gwadabawa","Illela","Kebbe","Kware","Rabah","Sabon Birni","Shagari","Silame","Sokoto North","Sokoto South","Tambuwal","Tangaza","Tureta","Wamako","Wurno","Yabo","Goronyo",

    // Taraba (16)
    "Ardo Kola","Bali","Donga","Gashaka","Gassol","Ibi","Jalingo","Karim Lamido","Kona","Kurmi","Lau","Sardauna","Takum","Ussa","Wukari","Yorro","Zing",

    // Yobe (17)
    "Bade","Bursari","Damaturu","Fika","Fune","Geidam","Gujba","Gulani","Jakusko","Karasuwa","Machina","Nangere","Nguru","Potiskum","Tarmuwa","Yunusari","Yusufari",

    // Zamfara (14)
    "Anka","Bakura","Birnin Magaji/Kiyaw","Bukkuyum","Bungudu","Gummi","Gusau","Kaura Namoda","Maradun","Maru","Shinkafi","Talata Mafara","Tsafe","Zurmi"
];

        // --- DOM Elements ---
        const lgaGrid = document.getElementById('lga-grid');
        const searchInput = document.getElementById('search-input');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const currentPageDisplay = document.getElementById('current-page-display');
        const totalPagesDisplay = document.getElementById('total-pages-display');
        const totalRecordsDisplay = document.getElementById('total-records-display');
        const paginationControls = document.getElementById('pagination-controls');
        const loadingSpinner = document.getElementById('loading-spinner');
        const logoutBtn = document.getElementById('logout-btn');
        const adminEmailDisplay = document.getElementById('admin-email');
        const toastContainer = document.getElementById('toast-container');
        const addLgaBtn = document.getElementById('add-lga-btn');
        
        // --- ADD Modal Elements (Standard Form IDs) ---
        const lgaModal = document.getElementById('lga-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const coordsDisplay = document.getElementById('coords-display');
        const latitudeInput = document.getElementById('latitude-input');
        const longitudeInput = document.getElementById('longitude-input');
        const lgaSearchInput = document.getElementById('lga-search-input');
        const lgaHiddenInput = document.getElementById('lga-hidden-input');
        const lgaDropdownContainer = document.getElementById('lga-dropdown-container');
        const lgaFilterInput = document.getElementById('lga-filter-input');
        const lgaListContainer = document.getElementById('lga-list-container');
        const lgaSerialSelect = document.getElementById('lga-serial-select');
        const lgaErrorMsg = document.getElementById('lga-error-msg');
        const nextStep1Btn = document.getElementById('next-step-1');
        const useCurrentLocationBtn = document.getElementById('use-current-location-btn');
        const nextStep2Btn = document.getElementById('next-step-2');
        const backStep2Btn = document.getElementById('back-step-2');
        const backStep3Btn = document.getElementById('back-step-3');
        const nextStep3Btn = document.getElementById('next-step-3'); // Added Step 3 Next Button
        const backStep4Btn = document.getElementById('back-step-4'); // Added Step 4 Back Button
        const submitLgaFormBtn = document.getElementById('submit-lga-form-btn');
        const lgaForm = document.getElementById('lga-form');
        const addFormSteps = [
            document.getElementById('step-1'),
            document.getElementById('step-2'),
            document.getElementById('step-3'),
            document.getElementById('step-4')
        ];
        
        // Time input elements
        const opensHourInput = document.getElementById('opens-hour-input');
        const opensMinuteInput = document.getElementById('opens-minute-input');
        const closesHourInput = document.getElementById('closes-hour-input');
        const closesMinuteInput = document.getElementById('closes-minute-input');

        // --- Utility Functions ---
        
        /**
         * Navigates to the LGA details page.
         * @param {string} lgaId The unique ID of the LGA attendance point.
         */
        function viewLgaDetails(lgaId) {
             window.location.href = `${LGA_DETAILS_PAGE}?id=${lgaId}`;
        }


        /**
         * Copies the full URL with the LGA token to the clipboard.
         * The format is: {BASE_URL}{CORP_MEMBER_PORTAL_PATH}?token={token}
         * @param {string} token The unique token for the LGA attendance point.
         */
        function copyLgaUrl(token, event) {
            // Stop propagation to prevent the card click event from firing
            event.stopPropagation();
            // Construct the full URL
            const fullUrl = `${window.location.origin}?token=${token}`;
            copyToClipboard(fullUrl);
        }

        /**
         * Generic function to copy text to clipboard.
         * @param {string} text The text to copy.
         */
        function copyToClipboard(text) {
             // Use the preferred clipboard API (navigator.clipboard.writeText)
            // with a fallback for older browsers or environments like iframes
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast("Link copied to clipboard: " + text, 'success');
                    })
                    .catch(err => {
                        // Fallback in case of clipboard API failure
                        copyToClipboardFallback(text);
                    });
            } else {
                // Fallback for document.execCommand
                copyToClipboardFallback(text);
            }
        }

        /**
         * Fallback mechanism to copy text using document.execCommand('copy').
         * @param {string} text The text to copy.
         */
        function copyToClipboardFallback(text) {
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showToast("Link copied to clipboard (Fallback): " + text, 'success');
            } catch (err) {
                showToast("Failed to copy link. Please copy manually: " + text, 'error');
            }
        }

        /**
         * Clears authentication tokens and redirects to login.
         */
        function logout() {
            localStorage.removeItem('nyscadminjwt');
            localStorage.removeItem('nyscadminexpiresTime');
            localStorage.removeItem('nyscadminId');
            localStorage.removeItem('nyscadminEmail');
            window.location.href = "/Excoportal/auth/login.html";
        }

        /**
         * Checks authentication state and redirects if invalid or expired.
         * @returns {string | null} The JWT token if valid, otherwise null.
         */
        function getValidToken() {
            const token = localStorage.getItem('nyscadminjwt');
            const expiryTimeStr = localStorage.getItem('nyscadminexpiresTime');
            const email = localStorage.getItem('nyscadminEmail');

            if (email) {
                adminEmailDisplay.textContent = email;
            }

            if (token && expiryTimeStr) {
                const expiryTime = new Date(expiryTimeStr).getTime();
                const currentTime = new Date().getTime();

                if (currentTime < expiryTime) {
                    return token; // Token is valid
                }
            }
            // Token missing or expired
            console.log("Authentication token invalid or expired. Redirecting to login.");
            logout();
            return null;
        }

        /**
         * Shows a sliding toast notification.
         * @param {string} message The message to display.
         * @param {'success'|'error'} type The type of toast (affects color and icon).
         */
        function showToast(message, type) {
            const isSuccess = type === 'success';
            const bgColor = isSuccess ? 'bg-green-500' : 'bg-red-500';
            const icon = isSuccess ? 'fa-circle-check' : 'fa-circle-exclamation';

            // 1. Create the toast HTML
            toastContainer.innerHTML = `
                <div id="active-toast" class="flex items-center p-4 rounded-lg shadow-xl text-white ${bgColor}">
                    <i class="fa-solid ${icon} mr-3 text-lg"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;

            // 2. Slide in
            toastContainer.classList.remove('translate-x-full');

            // 3. Slide out after duration
            setTimeout(() => {
                toastContainer.classList.add('translate-x-full');

                // 4. Clear content after transition ends
                setTimeout(() => {
                    toastContainer.innerHTML = '';
                }, 300); // Match CSS transition duration
            }, TOAST_DURATION);
        }

        /**
         * Renders the list of LGA records into the grid, showing coordinates instead of address.
         * Edit button removed to disable editing.
         */
        function renderLGA(records) {
            lgaGrid.innerHTML = ''; // Clear previous content

            if (records.length === 0) {
                lgaGrid.innerHTML = `
                    <div class="col-span-full text-center py-16 text-gray-500">
                        <i class="fa-solid fa-location-dot text-6xl mb-4"></i>
                        <p class="text-xl font-semibold">No LGA Locations Found</p>
                        <p class="mt-2">Try adjusting your search criteria or add a new location.</p>
                    </div>`;
                return;
            }

            records.forEach(lga => {
                const getCoord = (coord) => {
                    const value = typeof coord === 'string' ? parseFloat(coord) : coord;
                    if (value !== null && typeof value !== 'undefined' && !isNaN(value)) {
                        return value.toFixed(6);
                    }
                    return 'N/A';
                };

                const latitude = getCoord(lga.latitude);
                const longitude = getCoord(lga.longitude);
                const coordinates = `Lat: ${latitude}, Lon: ${longitude}`;
                
                console.log("Attendance coordinates", coordinates)

                const card = document.createElement('div');
                card.className = 'lga-grid-item nysc-card hover:shadow-xl transition relative';
                
                // Add click listener to navigate to details page
                card.addEventListener('click', () => {
                    viewLgaDetails(lga.id);
                });

                card.innerHTML = `
                    <div class="space-y-1 pr-8">
                        <h3 class="text-lg font-bold text-gray-900 overflow-hidden text-ellipsis whitespace-nowrap" 
                            title="${lga.name}">${lga.name}
                        </h3>
                        <div class="flex items-center space-x-2">
                            <p class="text-xs text-gray-500 font-mono">Token: ${lga.token}</p>
                            <button onclick="copyLgaUrl('${lga.token}', event)" 
                                class="text-gray-400 hover:text-green-500 transition duration-150 p-1 rounded-full bg-gray-50 hover:bg-green-100"
                                title="Copy Corps Member Attendance Link">
                                <i class="fa-solid fa-copy text-xs"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500">Radius: ${lga.distanceInMeters}m</p>
                    </div>
                    <div class="pt-2 border-t border-gray-100 text-sm text-gray-600">
                        <p class="text-xs font-semibold nysc-green-text">Coordinates: ${coordinates}</p>
                        <p class="text-xs text-gray-500">Time: ${lga.opensAt} - ${lga.closesAt}</p>
                    </div>
                `;
                lgaGrid.appendChild(card);
            });
        }


        /**
         * Updates the pagination controls based on the API response metadata.
         * @param {Object} metadata Pagination metadata from the API response value.
         */
        function updatePaginationControls(metadata) {
            const { currentPage: current, totalPages, totalRecordCount } = metadata;

            currentPageDisplay.textContent = current;
            totalPagesDisplay.textContent = totalPages;
            totalRecordsDisplay.textContent = totalRecordCount;

            prevPageBtn.disabled = current <= 1;
            nextPageBtn.disabled = current >= totalPages;

            // Show controls if there's more than one page
            if (totalPages > 1) {
                paginationControls.classList.remove('hidden');
            } else {
                paginationControls.classList.add('hidden');
            }
        }

        // --- Core Data Fetching Logic ---

        let fetchTimeout; // To handle search debouncing

        /**
         * Fetches LGA data with current pagination and search parameters.
         * @param {string} search The search query string.
         * @param {number} pageNumber The page number to fetch.
         */
        async function fetchLGAData(search = '', pageNumber = 1) {
            const token = getValidToken();
            if (!token) return;

            // Show loading state
            lgaGrid.innerHTML = '';
            lgaGrid.appendChild(loadingSpinner);
            loadingSpinner.classList.remove('hidden');
            paginationControls.classList.add('hidden');

            const queryParams = new URLSearchParams({
                search: search,
                pageNumber: pageNumber,
                pageSize: pageSize
            }).toString();

            const fetchUrl = `${LGA_ENDPOINT}?${queryParams}`;

            try {
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        // The 'Bearer ' prefix is correctly applied here
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    // Unauthorized/Token expired even after initial check
                    showToast("Session expired. Please log in again.", 'error');
                    return logout();
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.status === true && data.value) {
                    const { records, ...metadata } = data.value;
                    currentPage = metadata.currentPage;

                    renderLGA(records);
                    updatePaginationControls(metadata);

                } else {
                    renderLGA([]); // Render empty state
                    showToast(data.message || "Failed to retrieve LGA points.", 'error');
                }
            } catch (error) {
                console.error("Error fetching LGA data:", error);
                renderLGA([]); // Render empty state
                showToast("Network Error: Could not connect to the server.", 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }


        // --- Reusable Modal Logic ---

        /**
         * Updates the map and form inputs with new coordinates (ADD mode only).
         * @param {number} lat Latitude.
         * @param {number} lng Longitude.
         * @param {boolean} isCurrentLocation If the location is from geolocation.
         */
        function updateLocation(lat, lng, isCurrentLocation = false) {
            const fixedLat = parseFloat(lat).toFixed(6);
            const fixedLng = parseFloat(lng).toFixed(6);
            const latlng = [lat, lng];

            // Always update ADD inputs
            selectedCoords.lat = parseFloat(fixedLat);
            selectedCoords.lng = parseFloat(fixedLng);

            latitudeInput.value = fixedLat;
            longitudeInput.value = fixedLng;

            // Center map and remove/add marker
            map.setView(latlng, 13); // Zoom closer on selection

            if (marker) {
                map.removeLayer(marker);
            }

            const locationText = isCurrentLocation ? "Your Current Location" : "Attendance Location";
            marker = L.marker(latlng).addTo(map)
                .bindPopup(locationText)
                .openPopup();

            // Update UI
            coordsDisplay.textContent = `Coordinaes: Lat: ${fixedLat}, Lon: ${fixedLng}`;
            nextStep1Btn.disabled = false;
        }

        /**
         * Handles the success callback for Geolocation API.
         * @param {Object} position GeolocationPosition object.
         */
        function onGeolocationSuccess(position) {
            const { latitude, longitude } = position.coords;
            useCurrentLocationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Use Current Location';
            useCurrentLocationBtn.disabled = false;
            updateLocation(latitude, longitude, true);
            showToast("Current location successfully detected and marked.", 'success');
        }

        /**
         * Handles the error callback for Geolocation API.
         * @param {Object} error GeolocationPositionError object.
         */
        function onGeolocationError(error) {
            useCurrentLocationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Use Current Location';
            useCurrentLocationBtn.disabled = false;
            let message = "Could not get location. ";
            if (error.code === 1) {
                message += "Access denied. Please enable location services.";
            } else if (error.code === 2) {
                message += "Location unavailable.";
            } else {
                message += "Timeout or unknown error.";
            }
            showToast(message, 'error');
        }

        /**
         * Initializes the Leaflet map (ADD mode only).
         */
        function initMap(lat = 9.0820, lng = 8.6753, zoom = 6) {
            const mapContainerId = 'map-container';

            if (map) {
                map.remove();
                marker = null;
            }
            
            map = L.map(mapContainerId, {
                attributionControl: false,
                zoomControl: true,
                scrollWheelZoom: true
            }).setView([lat, lng], zoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add a click handler
            map.on('click', onMapClick);
        }

        /**
         * Handles map click event to place marker and update coordinates.
         * @param {Object} e Leaflet map event object.
         */
        function onMapClick(e) {
            updateLocation(e.latlng.lat, e.latlng.lng);
        }

        /**
         * Initializes the searchable LGA list state for ADD mode.
         */
        function loadLGAOptions() {
            lgaSearchInput.value = ''; // Reset display
            lgaHiddenInput.value = ''; // Reset hidden value
            lgaFilterInput.value = ''; // Reset filter input
            nextStep2Btn.disabled = true;
            filterLGAs(''); // Initial population of the list
        }
        
        /**
         * Filters the LGA list based on search input and updates the display (ADD mode).
         * @param {string} searchTerm The text to search for.
         */
        function filterLGAs(searchTerm) {
            const listContainer = lgaListContainer;
            const searchInputEl = lgaSearchInput;
            const hiddenInput = lgaHiddenInput;
            const dropdownContainer = lgaDropdownContainer;
            const nextBtn = nextStep2Btn;
            const errorMsg = lgaErrorMsg;

            listContainer.innerHTML = ''; // Clear previous results
            
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filteredLGAs = allNigerianLGAs.filter(lga =>
                lga.toLowerCase().includes(lowerCaseSearchTerm)
            ).sort(); // Sort alphabetically for better UX

            if (filteredLGAs.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-3 text-gray-500 text-sm">No LGA found matching "${searchTerm}"</div>
                `;
                return;
            }

            filteredLGAs.forEach(lga => {
                const item = document.createElement('div');
                item.className = 'p-2 text-gray-800 text-sm border-b border-gray-100 last:border-b-0 cursor-pointer hover:bg-green-50';
                item.textContent = lga;
                
                // Add click listener to select the LGA
                item.addEventListener('click', () => {
                    searchInputEl.value = lga;      // Update visible field
                    hiddenInput.value = lga;      // Update hidden field for submission
                    dropdownContainer.classList.add('hidden'); // Hide dropdown
                    nextBtn.disabled = false;   // Enable next step
                    errorMsg.classList.add('hidden'); // Hide error message
                });
                
                listContainer.appendChild(item);
            });
        }


        /**
         * Opens the ADD modal and resets the form to Step 1.
         */
        function openAddModal() {
            lgaModal.classList.remove('hidden');
            currentStep = 1;
            updateStepVisibility();

            // Reset form state on open
            lgaForm.reset();
            selectedCoords = { lat: null, lng: null };
            coordsDisplay.textContent = 'Coordinaes: Not Selected';
            nextStep1Btn.disabled = true;
            lgaSearchInput.value = '';
            lgaHiddenInput.value = '';
            nextStep2Btn.disabled = true;
            lgaErrorMsg.classList.add('hidden');
            
            // Reset time pickers to default (09:00)
            opensHourInput.value = '09';
            opensMinuteInput.value = '00';
            closesHourInput.value = '09';
            closesMinuteInput.value = '00';
            document.getElementById('opens-at-input').value = '';
            document.getElementById('closes-at-input').value = '';

            // Re-initialize map to ensure it renders correctly inside the modal
            setTimeout(() => {
                initMap();
                if (map) map.invalidateSize();
            }, 100);
        }

        /**
         * Closes the ADD modal and resets form state.
         */
        function closeAddModal() {
            lgaModal.classList.add('hidden');
            lgaForm.reset();
            if (marker) map.removeLayer(marker);
            marker = null;
        }

        /**
         * Updates which step of the form is visible (ADD mode).
         */
        function updateStepVisibility() {
            const steps = addFormSteps;

            steps.forEach((step, index) => {
                if (index === currentStep - 1) {
                    step.classList.remove('hidden');
                } else {
                    step.classList.add('hidden');
                }
            });

            // Re-render map if it becomes visible
            if (currentStep === 1 && map) {
                setTimeout(() => map.invalidateSize(), 50);
            }
        }

        /**
         * Moves to the next step, handling any step-specific setup.
         */
        function nextStep() {
            if (currentStep === 1) {
                // ADD Mode Validation: ensure coords selected
                if (!selectedCoords.lat || !selectedCoords.lng) return;
                loadLGAOptions();
            } else if (currentStep === 2) {
                // ADD Mode Validation: LGA name is mandatory
                if (!lgaHiddenInput.value) {
                    lgaErrorMsg.classList.remove('hidden');
                    return;
                }
                lgaErrorMsg.classList.add('hidden');
            } else if (currentStep === 3) {
                // Step 3 validation: distance is already required by HTML, just proceed
            }

            if (currentStep < 4) {
                currentStep++;
                updateStepVisibility();
            }
        }

        /**
         * Moves to the previous step.
         */
        function prevStep() {
            if (currentStep === 2) {
                // Reset LGA selection state when going back from Step 2 (ADD mode)
                lgaSearchInput.value = '';
                lgaHiddenInput.value = '';
                nextStep2Btn.disabled = true;
                lgaErrorMsg.classList.add('hidden');
            } else if (currentStep === 3) {
                // document.getElementById('distance-input').value = '50'; // reset default if needed
            }

            if (currentStep > 1) {
                currentStep--;
                updateStepVisibility();
            }
        }
        
        // --- Time Picker Logic ---

        /**
         * Helper function to safely update hour or minute input with wrapping/clamping.
         * @param {string} inputId The ID of the input element.
         * @param {number} delta +1 for increment, -1 for decrement.
         * @param {number} max The maximum allowed value (e.g., 23 for hour, 59 for minute).
         * @param {boolean} isHour If true, handles hour formatting (H), otherwise minute (MM).
         */
        function updateTimeInput(inputId, delta, max, isHour = false) {
            const inputEl = document.getElementById(inputId);
            let currentValue = parseInt(inputEl.value, 10);
            let newValue = currentValue + delta;

            if (isHour) {
                // Hours (0-23)
                if (newValue < 0) newValue = 23;
                if (newValue > 23) newValue = 0;
            } else {
                // Minutes (0-59), wraps in steps of 5
                const step = 5;
                newValue = Math.round(newValue / step) * step;

                if (newValue < 0) newValue = 55;
                if (newValue > 59) newValue = 0;
            }

            // Format: H or HH for hours, MM for minutes
            inputEl.value = isHour ? String(newValue).padStart(2, '0') : String(newValue).padStart(2, '0');
        }

        // Opens At Time Controls
        function incrementOpensHour() { updateTimeInput('opens-hour-input', 1, 23, true); }
        function decrementOpensHour() { updateTimeInput('opens-hour-input', -1, 23, true); }
        function incrementOpensMinute() { updateTimeInput('opens-minute-input', 5, 59, false); }
        function decrementOpensMinute() { updateTimeInput('opens-minute-input', -5, 59, false); }

        // Closes At Time Controls
        function incrementClosesHour() { updateTimeInput('closes-hour-input', 1, 23, true); }
        function decrementClosesHour() { updateTimeInput('closes-hour-input', -1, 23, true); }
        function incrementClosesMinute() { updateTimeInput('closes-minute-input', 5, 59, false); }
        function decrementClosesMinute() { updateTimeInput('closes-minute-input', -5, 59, false); }

        /**
         * Formats the Opens At time to the required "H:MM" string.
         * @returns {string} Formatted time string.
         */
        function getOpensTime() {
            // Remove leading zero from hour if it's 0-9
            let hour = parseInt(opensHourInput.value, 10);
            const minute = opensMinuteInput.value;
            return `${hour}:${minute}`;
        }

        /**
         * Formats the Closes At time to the required "H:MM" string.
         * @returns {string} Formatted time string.
         */
        function getClosesTime() {
            // Remove leading zero from hour if it's 0-9
            let hour = parseInt(closesHourInput.value, 10);
            const minute = closesMinuteInput.value;
            return `${hour}:${minute}`;
        }


        /**
         * Handles the final form submission for CREATE (POST) only.
         */
        async function submitLGAForm() {
            const token = getValidToken();
            if (!token) return;

            const submitBtn = submitLgaFormBtn;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Submitting...';
            submitBtn.disabled = true;

            // Build payload (ADD only)
            let payload = {};
            const baseName = lgaHiddenInput.value;
            const serialNumber = lgaSerialSelect.value;

            if (!baseName) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                // This shouldn't happen if validation in Step 2 is correct, but added as a safeguard
                return showToast("Please select an LGA name (Step 2).", 'error'); 
            }
            payload.name = baseName + serialNumber;

            const latValue = latitudeInput.value;
            const lngValue = longitudeInput.value;
            if (!latValue || !lngValue) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                 // This shouldn't happen if validation in Step 1 is correct, but added as a safeguard
                return showToast("Please select a location on the map (Step 1).", 'error'); 
            }
            payload.latitude = parseFloat(latValue);
            payload.longitude = parseFloat(lngValue);

            const distanceValue = document.getElementById('distance-input').value;
            if (!distanceValue) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                 // This shouldn't happen if validation in Step 3 is correct, but added as a safeguard
                return showToast("Please set a distance (Step 3).", 'error'); 
            }
            payload.distanceInMeters = parseInt(distanceValue, 10);

            // Add opening and closing times (Step 4 data)
            const opensAt = getOpensTime();
            const closesAt = getClosesTime();

            // Perform simple time validation (Opens At must be before Closes At)
            const opensTimeValue = parseInt(opensHourInput.value, 10) * 60 + parseInt(opensMinuteInput.value, 10);
            const closesTimeValue = parseInt(closesHourInput.value, 10) * 60 + parseInt(closesMinuteInput.value, 10);
            
            if (closesTimeValue <= opensTimeValue) {
                 submitBtn.innerHTML = originalText;
                 submitBtn.disabled = false;
                 return showToast("Closing time must be after opening time.", 'error');
            }


            payload.opensAt = opensAt;
            payload.closesAt = closesAt;

            try {
                const response = await fetch(LGA_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.status === true) {
                    showToast("LGA Attendance Point created successfully!", 'success');
                    closeAddModal();
                    // Reset to first page of data to see the new entry
                    currentPage = 1; 
                    fetchLGAData(searchInput.value, currentPage);
                } else {
                    throw new Error(data.message || `Failed to create LGA point. Status: ${response.status}`);
                }
            } catch (error) {
                console.error("Error submitting LGA data:", error);
                showToast(error.message || "An unexpected error occurred during submission.", 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }


        // --- Event Handlers ---
        // Geolocation button handler
        function handleGeolocationClick() {
            if (navigator.geolocation) {
                useCurrentLocationBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Locating...';
                useCurrentLocationBtn.disabled = true;
                navigator.geolocation.getCurrentPosition(onGeolocationSuccess, onGeolocationError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                showToast("Geolocation is not supported by your browser.", 'error');
            }
        }
        useCurrentLocationBtn.addEventListener('click', handleGeolocationClick);

        // Pagination buttons
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchLGAData(searchInput.value, currentPage);
            }
        });
        nextPageBtn.addEventListener('click', () => {
            currentPage++;
            fetchLGAData(searchInput.value, currentPage);
        });

        // Search input with debounce
        searchInput.addEventListener('input', (e) => {
            clearTimeout(fetchTimeout);
            fetchTimeout = setTimeout(() => {
                currentPage = 1;
                fetchLGAData(e.target.value, currentPage);
            }, 500);
        });

        // Logout button
        logoutBtn.addEventListener('click', logout);

        // Modal Open/Close
        addLgaBtn.addEventListener('click', openAddModal);
        closeModalBtn.addEventListener('click', closeAddModal);
        lgaModal.addEventListener('click', (e) => {
            if (e.target === lgaModal) {
                closeAddModal();
            }
        });

        // Modal Navigation (ADD Mode)
        nextStep1Btn.addEventListener('click', nextStep);
        backStep2Btn.addEventListener('click', prevStep);
        nextStep2Btn.addEventListener('click', nextStep);
        backStep3Btn.addEventListener('click', prevStep);
        nextStep3Btn.addEventListener('click', nextStep); // Connect Step 3 to Step 4
        backStep4Btn.addEventListener('click', prevStep); // Back from Step 4

        // --- LGA SEARCH COMPONENT HANDLERS (ADD only) ---
        function setupSearchableLGAInput(searchInputEl, filterInputEl, dropdownContainerEl) {
            searchInputEl.addEventListener('click', () => {
                dropdownContainerEl.classList.remove('hidden');
                filterInputEl.focus();
                filterLGAs(filterInputEl.value);
            });
            filterInputEl.addEventListener('keyup', (e) => {
                filterLGAs(e.target.value);
            });
        }
        // Apply setup to ADD modal only
        setupSearchableLGAInput(lgaSearchInput, lgaFilterInput, lgaDropdownContainer);

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const isClickOutsideAdd = !lgaDropdownContainer.contains(e.target) && e.target !== lgaSearchInput && e.target !== lgaFilterInput;
            if (isClickOutsideAdd) {
                lgaDropdownContainer.classList.add('hidden');
            }
        });

        // LGA input changes
        function handleLGAInputChange() {
            const hiddenInput = lgaHiddenInput;
            const nextBtn = nextStep2Btn;
            const errorMsg = lgaErrorMsg;

            if (hiddenInput.value) {
                nextBtn.disabled = false;
                errorMsg.classList.add('hidden');
            } else {
                nextBtn.disabled = true;
            }
        }
        lgaSearchInput.addEventListener('change', handleLGAInputChange);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (getValidToken()) {
                fetchLGAData();
            }
        });
    </script>
</body>

</html>